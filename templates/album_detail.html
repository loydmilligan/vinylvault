{% extends "base.html" %}

{% block title %}{{ album.title }} - {{ album.artist }} - VinylVault{% endblock %}

{% block head %}
<style>
.album-detail {
    max-width: 1000px;
    margin: 0 auto;
}

.album-header {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 40px;
    margin-bottom: 40px;
}

.album-cover-large {
    width: 100%;
    aspect-ratio: 1;
    background: #333;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #444;
}

.album-cover-large img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.album-cover-placeholder-large {
    width: 80px;
    height: 80px;
    background: #444;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    color: #666;
}

.album-info-main {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 16px;
}

.album-title-large {
    font-size: 32px;
    font-weight: bold;
    line-height: 1.2;
    color: #fff;
}

.album-artist-large {
    font-size: 24px;
    color: #ff6b35;
    font-weight: 500;
}

.album-meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

.meta-item {
    background: #1a1a1a;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #333;
}

.meta-label {
    font-size: 12px;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.meta-value {
    font-size: 16px;
    font-weight: 500;
    color: #fff;
}

.rating-stars {
    color: #ffd700;
    font-size: 18px;
}

.album-sections {
    display: grid;
    gap: 32px;
}

.section {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 24px;
}

.section-title {
    font-size: 20px;
    font-weight: bold;
    color: #ff6b35;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.genres-styles {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.tag {
    background: rgba(255, 107, 53, 0.2);
    color: #ff6b35;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid rgba(255, 107, 53, 0.3);
}

.tag.style {
    background: rgba(255, 255, 255, 0.1);
    color: #ccc;
    border-color: rgba(255, 255, 255, 0.2);
}

.tracklist {
    list-style: none;
    padding: 0;
}

.track {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #333;
}

.track:last-child {
    border-bottom: none;
}

.track-info {
    flex: 1;
}

.track-title {
    font-weight: 500;
    margin-bottom: 4px;
}

.track-duration {
    color: #999;
    font-size: 14px;
    font-variant-numeric: tabular-nums;
}

.track-position {
    color: #666;
    font-size: 14px;
    margin-right: 16px;
    min-width: 30px;
}

.back-button {
    margin-bottom: 24px;
}

.action-buttons {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    flex-wrap: wrap;
}

.notes-content {
    line-height: 1.6;
    color: #ccc;
    white-space: pre-wrap;
}

.feedback-section {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 16px;
    padding: 12px;
    background: rgba(255, 107, 53, 0.1);
    border: 1px solid rgba(255, 107, 53, 0.3);
    border-radius: 8px;
}

.btn-feedback {
    min-width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.2s ease;
    background: #333;
    border: 2px solid #555;
}

.btn-feedback:hover {
    transform: scale(1.1);
    background: #444;
}

.btn-feedback.selected {
    border-color: #ff6b35;
    background: rgba(255, 107, 53, 0.2);
}

.btn-feedback:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Responsive */
@media (max-width: 768px) {
    .album-header {
        grid-template-columns: 1fr;
        gap: 24px;
        text-align: center;
    }
    
    .album-cover-large {
        max-width: 280px;
        margin: 0 auto;
    }
    
    .album-title-large {
        font-size: 24px;
    }
    
    .album-artist-large {
        font-size: 20px;
    }
    
    .album-meta-grid {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 12px;
    }
    
    .section {
        padding: 16px;
    }
}

@media (max-width: 480px) {
    .album-cover-large {
        max-width: 240px;
    }
    
    .album-title-large {
        font-size: 20px;
    }
    
    .album-artist-large {
        font-size: 18px;
    }
    
    .track {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .track-position {
        margin-right: 0;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="album-detail">
    <div class="back-button">
        <a href="javascript:history.back()" class="btn btn-secondary">‚Üê Back</a>
    </div>
    
    <div class="album-header">
        <div class="album-cover-large">
            {% if album.cover_url or album.custom_image %}
                <img data-src="{{ get_best_image_url(album, 'detail') }}" 
                     data-original-src="{{ album.cover_url or album.custom_image }}"
                     data-size-type="detail"
                     src="{{ get_placeholder_url('detail') }}"
                     alt="{{ album.title }}"
                     class="lazy-load"
                     loading="lazy">
            {% else %}
                <img src="{{ get_placeholder_url('detail') }}" 
                     alt="{{ album.title }}"
                     class="placeholder">
            {% endif %}
        </div>
        
        <div class="album-info-main">
            <h1 class="album-title-large">{{ album.title }}</h1>
            <div class="album-artist-large">{{ album.artist }}</div>
            
            <div class="album-meta-grid">
                {% if album.year %}
                <div class="meta-item">
                    <div class="meta-label">Year</div>
                    <div class="meta-value">{{ album.year }}</div>
                </div>
                {% endif %}
                
                {% if album.rating %}
                <div class="meta-item">
                    <div class="meta-label">Rating</div>
                    <div class="meta-value rating-stars">
                        {% for i in range(album.rating) %}‚òÖ{% endfor %}
                        {% for i in range(5 - album.rating) %}‚òÜ{% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if album.play_count %}
                <div class="meta-item">
                    <div class="meta-label">Plays</div>
                    <div class="meta-value">{{ album.play_count }}</div>
                </div>
                {% endif %}
                
                {% if album.date_added %}
                <div class="meta-item">
                    <div class="meta-label">Added</div>
                    <div class="meta-value">{{ album.date_added[:10] }}</div>
                </div>
                {% endif %}
            </div>
            
            <div class="action-buttons">
                <a href="{{ url_for('edit_album', album_id=album.id) }}" class="btn">‚úèÔ∏è Edit Album</a>
                {% if album.lrc_lyrics %}
                    <a href="{{ url_for('lyrics_display', album_id=album.id) }}" class="btn btn-secondary">üéµ Show Lyrics</a>
                {% endif %}
                <a href="{{ url_for('random_album') }}" class="btn">Random Album</a>
                <button onclick="shareAlbum()" class="btn btn-secondary">Share</button>
                
                <!-- Random Algorithm Feedback (shown only if came from random) -->
                <div id="feedback-section" class="feedback-section" style="display: none;">
                    <span style="color: #999; font-size: 14px; margin-right: 10px;">How was this selection?</span>
                    <button onclick="sendFeedback(1)" class="btn btn-feedback btn-like" title="I like this selection">üëç</button>
                    <button onclick="sendFeedback(0)" class="btn btn-feedback btn-neutral" title="Neutral">üòê</button>
                    <button onclick="sendFeedback(-1)" class="btn btn-feedback btn-dislike" title="I don't like this selection">üëé</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="album-sections">
        {% if album.genres or album.styles %}
        <div class="section">
            <h2 class="section-title">
                üè∑Ô∏è Genres & Styles
            </h2>
            <div class="genres-styles">
                {% for genre in album.genres %}
                    <span class="tag">{{ genre }}</span>
                {% endfor %}
                {% for style in album.styles %}
                    <span class="tag style">{{ style }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if album.songs %}
        <div class="section">
            <h2 class="section-title">
                üéµ Songs & Lyrics
                <button onclick="showBufferSettings()" class="btn btn-small" style="margin-left: auto; font-size: 12px;">
                    ‚öôÔ∏è Buffer Settings
                </button>
            </h2>
            
            <!-- Record Side Status -->
            {% if album.record_sides %}
            <div class="record-sides-status" style="margin-bottom: 20px;">
                {% for side in album.record_sides %}
                <div class="side-status" style="display: inline-block; margin-right: 16px; padding: 8px 12px; border: 1px solid #333; border-radius: 8px; {% if side.is_complete %}background: rgba(40, 167, 69, 0.2); border-color: #28a745;{% else %}background: rgba(255, 107, 53, 0.1); border-color: #ff6b35;{% endif %}">
                    <strong>Side {{ side.side_label }}</strong>: 
                    {{ side.tracks_with_lrc }}/{{ side.total_tracks }} with lyrics
                    {% if side.is_complete %}
                        <span style="color: #28a745;">‚úì Complete</span>
                        <button onclick="combineLRC('{{ side.side_label }}')" class="btn btn-small" style="margin-left: 8px; font-size: 11px; padding: 4px 8px;">
                            üîó Combine LRC
                        </button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Songs by Record Side -->
            {% set sides_with_songs = album.songs|groupby('record_side') %}
            {% for side_label, songs in sides_with_songs %}
            <div class="record-side-section" style="margin-bottom: 32px;">
                <h3 style="color: #ff6b35; font-size: 18px; margin-bottom: 16px; border-bottom: 1px solid #333; padding-bottom: 8px;">
                    üíø Side {{ side_label }}
                </h3>
                
                <div class="songs-list">
                    {% for song in songs %}
                    <div class="song-item" style="display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #333;">
                        <span class="track-position" style="color: #666; font-size: 14px; margin-right: 16px; min-width: 30px;">
                            {{ song.track_position }}
                        </span>
                        
                        <div class="song-info" style="flex: 1;">
                            <div class="song-title" style="font-weight: 500; margin-bottom: 4px;">
                                {{ song.title }}
                            </div>
                            {% if song.duration_seconds %}
                            <div class="song-duration" style="color: #999; font-size: 14px;">
                                {{ (song.duration_seconds // 60)|int }}:{{ '%02d'|format((song.duration_seconds % 60)|int) }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="song-actions" style="display: flex; align-items: center; gap: 8px;">
                            {% if song.has_lrc %}
                                <span class="lrc-status" style="color: #28a745; font-size: 12px;">‚úì LRC</span>
                            {% else %}
                                <span class="lrc-status" style="color: #999; font-size: 12px;">No LRC</span>
                            {% endif %}
                            
                            <button onclick="openSongLRCModal({{ song.id }}, '{{ song.title|e }}', '{{ side_label }}')" 
                                    class="btn btn-small" 
                                    style="font-size: 11px; padding: 6px 12px;">
                                {% if song.has_lrc %}üìù Edit{% else %}üìÑ Add{% endif %} LRC
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% elif album.tracklist %}
        <!-- Fallback to old tracklist if no songs in database yet -->
        <div class="section">
            <h2 class="section-title">
                üéµ Tracklist
            </h2>
            <ol class="tracklist">
                {% for track in album.tracklist %}
                <li class="track">
                    <span class="track-position">{{ track.position or loop.index }}</span>
                    <div class="track-info">
                        <div class="track-title">{{ track.title }}</div>
                        {% if track.artists and track.artists != album.artist %}
                            <div class="track-artist">{{ track.artists }}</div>
                        {% endif %}
                    </div>
                    {% if track.duration %}
                        <span class="track-duration">{{ track.duration }}</span>
                    {% endif %}
                </li>
                {% endfor %}
            </ol>
        </div>
        {% endif %}
        
        {% if album.notes %}
        <div class="section">
            <h2 class="section-title">
                üìù Notes
            </h2>
            <div class="notes-content">{{ album.notes }}</div>
        </div>
        {% endif %}
        
        <!-- Additional album info -->
        <div class="section">
            <h2 class="section-title">
                ‚ÑπÔ∏è Details
            </h2>
            <div class="album-meta-grid">
                <div class="meta-item">
                    <div class="meta-label">Discogs ID</div>
                    <div class="meta-value">{{ album.discogs_id }}</div>
                </div>
                {% if album.folder_id %}
                <div class="meta-item">
                    <div class="meta-label">Folder</div>
                    <div class="meta-value">{{ album.folder_id }}</div>
                </div>
                {% endif %}
                {% if album.last_played %}
                <div class="meta-item">
                    <div class="meta-label">Last Played</div>
                    <div class="meta-value">{{ album.last_played[:10] }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Modal for LRC Upload -->
<div id="lrcModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);">
    <div class="modal-content" style="background-color: #1a1a1a; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 600px; border: 1px solid #333;">
        <div class="modal-header" style="background: #2a2a2a; padding: 20px; border-radius: 12px 12px 0 0; border-bottom: 1px solid #333;">
            <h3 style="margin: 0; color: #ff6b35; display: flex; justify-content: space-between; align-items: center;">
                <span id="modalTitle">Add LRC File</span>
                <span onclick="closeLRCModal()" style="cursor: pointer; font-size: 24px; color: #999;">&times;</span>
            </h3>
        </div>
        
        <div class="modal-body" style="padding: 20px;">
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; color: #ff6b35; margin-bottom: 8px; font-weight: 500;">LRC Content:</label>
                <textarea id="lrcContent" placeholder="[00:12.00]First line of lyrics&#10;[00:15.50]Second line of lyrics&#10;[00:18.30]Third line of lyrics" 
                         style="width: 100%; height: 200px; padding: 12px; background: #2a2a2a; border: 1px solid #444; border-radius: 8px; color: #fff; font-family: monospace; font-size: 14px; resize: vertical;"></textarea>
                <div style="font-size: 12px; color: #666; margin-top: 4px;">
                    Format: [mm:ss.xx]Lyrics text. Example: [01:23.45]Hello world
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; color: #ff6b35; margin-bottom: 8px; font-weight: 500;">Song Buffer (seconds):</label>
                <input type="number" id="songBuffer" step="0.1" min="0" max="30" 
                       style="width: 100px; padding: 8px 12px; background: #2a2a2a; border: 1px solid #444; border-radius: 8px; color: #fff;">
                <div style="font-size: 12px; color: #666; margin-top: 4px;">
                    Time to add between this song and the next when combining LRC files. Leave empty to use album/collection default.
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; color: #ff6b35; margin-bottom: 8px; font-weight: 500;">File Name (optional):</label>
                <input type="text" id="lrcFilename" placeholder="song-lyrics.lrc" 
                       style="width: 100%; padding: 8px 12px; background: #2a2a2a; border: 1px solid #444; border-radius: 8px; color: #fff;">
            </div>
            
            <div class="modal-actions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button onclick="closeLRCModal()" class="btn" style="background: #333; border: 1px solid #555;">Cancel</button>
                <button onclick="deleteSongLRC()" id="deleteBtn" class="btn" style="background: #dc3545; border: 1px solid #dc3545; display: none;">üóëÔ∏è Delete</button>
                <button onclick="saveSongLRC()" class="btn" style="background: #28a745; border: 1px solid #28a745;">üíæ Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Buffer Settings -->
<div id="bufferModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);">
    <div class="modal-content" style="background-color: #1a1a1a; margin: 10% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 500px; border: 1px solid #333;">
        <div class="modal-header" style="background: #2a2a2a; padding: 20px; border-radius: 12px 12px 0 0; border-bottom: 1px solid #333;">
            <h3 style="margin: 0; color: #ff6b35; display: flex; justify-content: space-between; align-items: center;">
                <span>Song Buffer Settings</span>
                <span onclick="closeBufferModal()" style="cursor: pointer; font-size: 24px; color: #999;">&times;</span>
            </h3>
        </div>
        
        <div class="modal-body" style="padding: 20px;">
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; color: #ff6b35; margin-bottom: 8px; font-weight: 500;">Global Default:</label>
                <input type="number" id="globalBuffer" step="0.1" min="0" max="30" value="{{ album.global_buffer_default }}"
                       style="width: 120px; padding: 8px 12px; background: #2a2a2a; border: 1px solid #444; border-radius: 8px; color: #fff;">
                <span style="color: #666; margin-left: 8px;">seconds</span>
                <div style="font-size: 12px; color: #666; margin-top: 4px;">
                    Default buffer time for all albums in your collection
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; color: #ff6b35; margin-bottom: 8px; font-weight: 500;">This Album:</label>
                <input type="number" id="albumBuffer" step="0.1" min="0" max="30" value="{{ album.song_buffer_seconds or '' }}" placeholder="Use global default"
                       style="width: 120px; padding: 8px 12px; background: #2a2a2a; border: 1px solid #444; border-radius: 8px; color: #fff;">
                <span style="color: #666; margin-left: 8px;">seconds</span>
                <div style="font-size: 12px; color: #666; margin-top: 4px;">
                    Override global default for this album. Leave empty to use global default.
                </div>
            </div>
            
            <div style="background: #2a2a2a; padding: 16px; border-radius: 8px; border: 1px solid #333; margin-bottom: 20px;">
                <h4 style="margin: 0 0 8px 0; color: #ff6b35; font-size: 14px;">Priority Order:</h4>
                <ol style="margin: 0; padding-left: 20px; color: #ccc; font-size: 12px;">
                    <li>Individual song setting (highest priority)</li>
                    <li>Album setting</li>
                    <li>Global collection default (lowest priority)</li>
                </ol>
            </div>
            
            <div class="modal-actions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button onclick="closeBufferModal()" class="btn" style="background: #333; border: 1px solid #555;">Cancel</button>
                <button onclick="saveBufferSettings()" class="btn" style="background: #28a745; border: 1px solid #28a745;">üíæ Save</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables for modal management
let currentSongId = null;
let currentSongTitle = '';
let currentSide = '';

function shareAlbum() {
    if (navigator.share) {
        navigator.share({
            title: '{{ album.title }} - {{ album.artist }}',
            text: 'Check out this album from my vinyl collection!',
            url: window.location.href
        }).catch(err => console.log('Error sharing:', err));
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('Album URL copied to clipboard!');
        }).catch(err => {
            console.log('Could not copy URL:', err);
        });
    }
}

// LRC Modal Functions
function openSongLRCModal(songId, songTitle, side) {
    currentSongId = songId;
    currentSongTitle = songTitle;
    currentSide = side;
    
    // Update modal title
    document.getElementById('modalTitle').textContent = `LRC for "${songTitle}" (Side ${side})`;
    
    // Load existing LRC data if available
    fetch(`/api/song/${songId}/lrc`)
        .then(response => response.json())
        .then(data => {
            if (response.ok && data.lrc_content) {
                document.getElementById('lrcContent').value = data.lrc_content;
                document.getElementById('lrcFilename').value = data.lrc_filename || '';
                document.getElementById('songBuffer').value = data.song_buffer_seconds || '';
                document.getElementById('deleteBtn').style.display = 'inline-block';
            } else {
                // Clear form for new LRC
                document.getElementById('lrcContent').value = '';
                document.getElementById('lrcFilename').value = '';
                document.getElementById('songBuffer').value = '';
                document.getElementById('deleteBtn').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading song data:', error);
        });
    
    // Show modal
    document.getElementById('lrcModal').style.display = 'block';
}

function closeLRCModal() {
    document.getElementById('lrcModal').style.display = 'none';
    currentSongId = null;
}

function saveSongLRC() {
    const lrcContent = document.getElementById('lrcContent').value.trim();
    const lrcFilename = document.getElementById('lrcFilename').value.trim();
    const bufferSeconds = document.getElementById('songBuffer').value;
    
    if (!lrcContent) {
        alert('Please enter LRC content');
        return;
    }
    
    fetch(`/api/song/${currentSongId}/lrc`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            lrc_content: lrcContent,
            lrc_filename: lrcFilename,
            buffer_seconds: bufferSeconds ? parseFloat(bufferSeconds) : null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeLRCModal();
            // Reload page to update UI
            window.location.reload();
        } else {
            alert('Error saving LRC: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving LRC:', error);
        alert('Error saving LRC file');
    });
}

function deleteSongLRC() {
    if (!confirm(`Remove LRC file for "${currentSongTitle}"?`)) {
        return;
    }
    
    fetch(`/api/song/${currentSongId}/lrc`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeLRCModal();
            // Reload page to update UI
            window.location.reload();
        } else {
            alert('Error removing LRC: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error removing LRC:', error);
        alert('Error removing LRC file');
    });
}

// Buffer Settings Modal Functions
function showBufferSettings() {
    document.getElementById('bufferModal').style.display = 'block';
}

function closeBufferModal() {
    document.getElementById('bufferModal').style.display = 'none';
}

function saveBufferSettings() {
    const globalBuffer = document.getElementById('globalBuffer').value;
    const albumBuffer = document.getElementById('albumBuffer').value;
    
    // Save global setting
    fetch('/api/settings/buffer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            global_default: parseFloat(globalBuffer),
            album_buffer: albumBuffer ? parseFloat(albumBuffer) : null,
            album_id: {{ album.id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeBufferModal();
            window.location.reload();
        } else {
            alert('Error saving settings: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving buffer settings:', error);
        alert('Error saving buffer settings');
    });
}

// LRC Combination Function
function combineLRC(side) {
    if (!confirm(`Combine all LRC files from Side ${side} into one continuous file?`)) {
        return;
    }
    
    fetch(`/api/album/{{ album.id }}/combine-lrc`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            side: side
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully combined Side ${side} LRC files!`);
            window.location.reload();
        } else {
            alert('Error combining LRC files: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error combining LRC files:', error);
        alert('Error combining LRC files');
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const lrcModal = document.getElementById('lrcModal');
    const bufferModal = document.getElementById('bufferModal');
    
    if (event.target === lrcModal) {
        closeLRCModal();
    } else if (event.target === bufferModal) {
        closeBufferModal();
    }
}

// Feedback system
let feedbackSent = false;

function sendFeedback(rating) {
    if (feedbackSent) return;
    
    const albumId = {{ album.id }};
    
    // Disable all feedback buttons
    const buttons = document.querySelectorAll('.btn-feedback');
    buttons.forEach(btn => btn.disabled = true);
    
    fetch('/api/random/feedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            album_id: albumId,
            feedback: rating
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            feedbackSent = true;
            
            // Highlight selected button
            buttons.forEach(btn => btn.classList.remove('selected'));
            const selectedButton = document.querySelector(`button[onclick="sendFeedback(${rating})"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
            }
            
            // Show thank you message
            setTimeout(() => {
                const feedbackSection = document.getElementById('feedback-section');
                if (feedbackSection) {
                    feedbackSection.innerHTML = '<span style="color: #999; font-size: 14px;">Thanks for your feedback! üéµ</span>';
                }
            }, 1000);
        } else {
            // Re-enable buttons on error
            buttons.forEach(btn => btn.disabled = false);
            console.error('Feedback error:', data.message);
        }
    })
    .catch(error => {
        console.error('Error sending feedback:', error);
        buttons.forEach(btn => btn.disabled = false);
    });
}

// Show feedback section if user came from random selection
function checkShowFeedback() {
    const referrer = document.referrer;
    const urlParams = new URLSearchParams(window.location.search);
    
    // Show feedback if came from random route or has feedback parameter
    if (referrer.includes('/random') || urlParams.has('feedback')) {
        const feedbackSection = document.getElementById('feedback-section');
        if (feedbackSection) {
            feedbackSection.style.display = 'flex';
        }
    }
}

// Initialize feedback on page load
document.addEventListener('DOMContentLoaded', checkShowFeedback);

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    switch(e.key) {
        case 'Escape':
            if (document.getElementById('lrcModal').style.display === 'block') {
                closeLRCModal();
            } else if (document.getElementById('bufferModal').style.display === 'block') {
                closeBufferModal();
            } else {
                history.back();
            }
            e.preventDefault();
            break;
        case 'Backspace':
            e.preventDefault();
            history.back();
            break;
        case 'r':
        case 'R':
            e.preventDefault();
            window.location.href = '{{ url_for("random_album") }}';
            break;
    }
});

// Swipe navigation for mobile
let touchStartX = 0;
let touchStartY = 0;

document.addEventListener('touchstart', function(e) {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
}, { passive: true });

document.addEventListener('touchend', function(e) {
    if (!touchStartX || !touchStartY) return;
    
    let touchEndX = e.changedTouches[0].clientX;
    let touchEndY = e.changedTouches[0].clientY;
    
    let deltaX = touchEndX - touchStartX;
    let deltaY = touchEndY - touchStartY;
    
    // Check if horizontal swipe is dominant
    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
        if (deltaX > 0) {
            // Swipe right - go back
            history.back();
        }
    }
    
    touchStartX = 0;
    touchStartY = 0;
}, { passive: true });
</script>
{% endblock %}